<%- include('../partials/admin/header') %>

<div id="page-wrapper">
    <div class="header">
      <h1 class="page-header">
        Edit Product
      </h1>
      <ol class="breadcrumb">
        <li><a href="#">Home</a></li>
        <li><a href="#">Forms</a></li>
        <li class="active">Data</li>
      </ol>

    </div>

    <div id="page-inner">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            
            <div class="card-content">
                <form class="col s12" action="/admin/product/editProduct/<%= id %>" method="post" id="productForm">
                    <div class="row">
                      <div class="input-field col s12">
                        <input placeholder="Product Name" id="productName" type="text" class="validate" name="productName" value="<%= name %>">
                        <div id="error1" class="text-danger"></div>
                      </div>
                    </div>
                    
                    <div class="row">
                      <div class="input-field col s12">
                        <input placeholder="Description" id="pDiscription" type="text" class="validate" name="productDiscription" value="<%= description %>">
                        <div id="error2" class="text-danger"></div>
                      </div>
                    </div>
                  
                    <div class="row">
                      <div class="input-field col s12">
                        <input placeholder="Price" id="productPrice" type="number" class="validate" name="productPrice" value="<%= price %>">
                        <div id="error3" class="text-danger"></div>
                      </div>
                    </div>
                    <% if(typeof croppedImage !== 'undefined'){ %>
                      <% for(let i=0;i<croppedImage.length;i++){ %>
                        <div class="row"> 
                          <div  ><img src="/uploads/<%= croppedImage[i] %>" alt="" style="width: 50px; height: 50px;"></div>
                        </div>
                      <% } %>
                    <% } %>
                    
                    <div class="row">
                      <div class="input-field col s12">
                        
                        <select id="category" name="productCategory" style="display: inline-block;">
                          <option value="" disabled selected><%= find.categoryName %></option>
                          <% if(typeof allCategory !== 'undifined'){ %>

                            <% for(let i=0;i<allCategory.length;i++){ %>
                              <option value="<%= allCategory[i]._id %>"><%= allCategory[i].categoryName %></option>
                            <% } %>

                          <% } %>
                          
                          
                        </select>
                      </div>
                    </div>
                  
                    
                  
                    <div class="row">
                      <div class="col s12">
                        <div id="variant-field-container">
                          <div class="input-field inline">
                            <select name="productSize" class="size" style="display: inline-block;">
                              <option value="<%= size %>" selected ><%= size %></option>
                              <option value="M">M</option>
                              <option value="S">S</option>
                              <option value="L">L</option>
                              <option value="XL">XL</option>
                            </select>
                            <span style="color: red;" class="error-size"></span>
                          </div>
                          
                          <div class="input-field inline">
                            <input placeholder="Stock" class="stock" type="number"  name="productStock" value="<%= stock %>">
                            <span style="color: red;" class="error-stock"></span>
                          </div>
                          <div class="input-field inline">
                            <button type="button" style="border:none" id="add-variant-field"><i
                                class="fa-solid fa-plus"></i></button>
                          </div>
                        </div>
                        <% if(typeof varient !== 'undefined') { %>
                            <% for(let i=1;i< varient.length ; i++){ %>
                              <div class="variant-add-group">
                                <div class="input-field inline">
                                  <select name="productSize" class="size" style="display: inline-block;">
                                    <option value="<%= varient[i].size %>" selected ><%= varient[i].size %></option>
                                    <option value="M">M</option>
                                    <option value="S">S</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                  </select>
                                  <span style="color: red;" class="error-size"></span>
                                </div>
                                
                                <div class="input-field inline">
                                  <input placeholder="Stock" type="number" class="stock validate" name="productStock" value="<%= varient[i].stock %>">
                                  <span style="color: red;" class="error-stock"></span>
                                </div>
                                <div class="input-field inline">
                                  <button style="border:none" class="remove-variant-field"><i class="fa-solid fa-minus"></i></button>
                                </div>
                              </div>
                              
                            <% } %>
                        <% } %>
                        
                        <div>
                          <button type="submit" class="btn btn-success" style="margin-top: 20px;">edit product</button>
                        </div>
                      </div>
                    </div>
                  </form>
                  
              <div class="clearBoth"></div>
            </div>
          </div>
        </div>
      </div>

      <script>
          document.addEventListener("DOMContentLoaded", function () {
          document.getElementById("add-variant-field").addEventListener("click", function (event) {
      
            console.log("button clicked");
            event.preventDefault();
            var newVariant = document.createElement('div');
            newVariant.classList.add('variant-add-group');  // Fixed class name 'variant-add-group'
      
            // Add input fields for Size, Color, and Stock
            newVariant.innerHTML =` 
              <div class="input-field inline">
                <select name="productSize" class="size" style="display: inline-block;">
                  <option value="" selected disabled>Size</option>
                  <option value="M">M</option>
                  <option value="S">S</option>
                  <option value="L">L</option>
                  <option value="XL">XL</option>
                </select>
                <span style="color: red;" class="error-size"></span>
              </div>
              
              <div class="input-field inline">
                <input placeholder="Stock" type="number" class="stock validate" name="productStock">
                <span style="color: red;" class="error-stock"></span>
              </div>
              <div class="input-field inline">
                <button style="border:none" class="remove-variant-field"><i class="fa-solid fa-minus"></i></button>
              </div>
            `;
      
            // Append the new variant group to the container
            document.getElementById('variant-field-container').appendChild(newVariant);
      
            // Handle remove variant field
            newVariant.querySelector('.remove-variant-field').addEventListener('click', function (e) {
              e.preventDefault();
              newVariant.remove();
            });
          });
      
          const existingRemoveButtons = document.querySelectorAll('.remove-variant-field');
          existingRemoveButtons.forEach(function (button) {
            button.addEventListener('click', function (event) {
              event.preventDefault();
              button.closest('.variant-add-group').remove(); // Remove the variant field
            });
          });
          
        });
      </script>
      
      <script>
        
        const productName=document.getElementById('productName');
        const productDiscription=document.getElementById('pDiscription')
        const productPrice=document.getElementById('productPrice')
        const productIimage=document.getElementById('productIimage')
        const error1=document.getElementById('error1')
        const error2=document.getElementById('error2')
        const error3=document.getElementById('error3')
        const error4=document.getElementById('error4')
        const form=document.getElementById('productForm')

        function validateVariantFields() {
        let isValid = true;  // Use this flag to track the validation status
        
        const sizeFields = document.querySelectorAll('.size');
        const stockFields = document.querySelectorAll('.stock');
        
        sizeFields.forEach((select, index) => {
            const errorSize = select.nextElementSibling; // Error span for size field
            if (select.value === "") {
                errorSize.textContent = "Please select a size";
                isValid = false;  // Set the flag to false if validation fails
            } else {
                errorSize.textContent = ""; // Clear error if valid
            }
        });

        stockFields.forEach((input, index) => {
            const errorStock = input.nextElementSibling; // Error span for stock field
            if (input.value === "" || input.value <= 0) {
                errorStock.textContent = "Please enter a valid stock quantity";
                isValid = false;  // Set the flag to false if validation fails
            } else {
                errorStock.textContent = "";  // Clear error if valid
            }
        });
        
        return isValid;  // Return the overall validation status
    }

        function nameValidation(){
          const nameVal=productName.value
          const namePattern=/^[A-Za-z\s&]+$/
          console.log("inside name validation "+nameVal)
          
          if(!namePattern.test(nameVal)){
            error1.innerHTML="name only contain caracters"
            return false
          }else{
            error1.innerHTML="";
            return true;
          }
          

        }

        function descriptionValidation(){
                const descrptionVal=productDiscription.value 
                
                if(descrptionVal.length>60){
                    error2.innerHTML="discription only allowed 60 caracters"
                    return false
                }else{
                    error2.innerHTML=""
                    return true
                }
        }
         
        function priceValidation(){

          const priceVal=parseFloat(productPrice.value) 

          console.log(typeof priceVal)
          if(priceVal<1){
            error3.innerHTML="enter a valid price"
            return false
          }else{
            error3.innerHTML='';
            return true;
          }
        }
        function imageValidation(){
          const fileLength=productIimage.files.length
          const allowedFile=3
          if(fileLength>allowedFile){
            error4.innerHTML="only allowed 3 image"
            return false
          }else if(fileLength<allowedFile){
            error4.innerHTML="need three images";
            return false
          }else{
            error4.innerHTML=""
            return true
          }
        }

        document.addEventListener("DOMContentLoaded",()=>{
          form.addEventListener("submit",(e)=>{
            const isName=nameValidation()
            const isDescription=descriptionValidation()
             const isPrice=priceValidation()
             const isVariant=validateVariantFields()

            if(!isName || !isDescription || !isPrice || !isVariant){
              e.preventDefault()
            }

          })
        })

      </script>
       
        <!-- /.panel-body -->
      </div>
      <!-- /.col-lg-12 -->
      <%- include('../partials/admin/footer') %>